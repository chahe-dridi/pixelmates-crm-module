name: CI Pipeline

on:
  push:
    branches:
      - main
      - dev
      - feature/adjust-form-position
      - devops
  pull_request:
    branches:
      - main
      - dev
      - devops

jobs:
  backend:
    name: Backend Build & Test
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:latest
        ports:
          - 27017:27017

    steps:
      - uses: actions/checkout@v3
      
      - uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'npm'
          cache-dependency-path: server/package-lock.json

      - run: |
          cd server
          npm ci
          npm run seed
          npm test

  back-office:
    name: Back Office Build & Test
    runs-on: ubuntu-latest
    needs: backend  # S'exécute seulement si le backend réussit

    steps:
      - uses: actions/checkout@v3
      
      - uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'npm'
          cache-dependency-path: back-office/package-lock.json

      - run: |
          cd back-office
          npm ci
          npm run build
          npm test

  front-office:
    name: Front Office Build & Test
    runs-on: ubuntu-latest
    needs: backend  # S'exécute seulement si le backend réussit

    steps:
      - uses: actions/checkout@v3
      
      - uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'npm'
          cache-dependency-path: front-office/package-lock.json

      - run: |
          cd front-office
          npm ci
          npm run build
          npm test

  docker-build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [backend, back-office, front-office]  # S'exécute après tous les tests
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Build backend image
        run: |
          cd server
          docker build -t backend .
          
      - name: Build back-office image
        run: |
          cd back-office
          docker build -t backoffice .
          
      - name: Build front-office image
        run: |
          cd front-office
          docker build -t frontoffice .